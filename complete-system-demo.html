<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>النظام الشامل - إدارة الوثائق والإشعارات</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* General Styles */
    :root {
      --primary-color: #3498db;
      --primary-color-dark: #2980b9;
      --secondary-color: #2c3e50;
      --bg-color: #f8f9fa;
      --text-color: #333;
      --border-color: #ddd;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --teacher-color: #3498db;
      --parent-color: #8e44ad;
      --student-color: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      direction: rtl;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 15px;
    }
    
    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo h1 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-switcher {
      background-color: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .user-switcher option {
      color: var(--text-color);
    }
    
    .notifications-btn {
      position: relative;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .notifications-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Demo Controls */
    .demo-controls {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .demo-controls h3 {
      color: var(--secondary-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .demo-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .demo-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      text-align: center;
      justify-content: center;
    }
    
    .demo-btn.homework {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }
    
    .demo-btn.lesson {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
    }
    
    .demo-btn.material {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }
    
    .demo-btn.notification {
      background: linear-gradient(135deg, #8e44ad, #7d3c98);
      color: white;
    }
    
    .demo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* Stats Dashboard */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .stat-card.documents .stat-icon {
      color: var(--primary-color);
    }
    
    .stat-card.notifications .stat-icon {
      color: var(--warning-color);
    }
    
    .stat-card.users .stat-icon {
      color: var(--success-color);
    }
    
    .stat-card.files .stat-icon {
      color: var(--info-color);
    }
    
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 16px;
    }
    
    /* Activity Log */
    .activity-log {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin: 20px 0;
      overflow: hidden;
    }
    
    .activity-log-header {
      background: var(--secondary-color);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .activity-log-content {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .activity-item {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      flex-shrink: 0;
    }
    
    .activity-icon.homework {
      background: var(--warning-color);
    }
    
    .activity-icon.lesson {
      background: var(--success-color);
    }
    
    .activity-icon.material {
      background: var(--info-color);
    }
    
    .activity-icon.notification {
      background: var(--primary-color);
    }
    
    .activity-details {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 4px;
    }
    
    .activity-description {
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .activity-time {
      color: #999;
      font-size: 12px;
    }
    
    /* User Role Indicator */
    .user-role {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .user-role.teacher {
      background: rgba(52, 152, 219, 0.2);
      color: #2980b9;
    }
    
    .user-role.parent {
      background: rgba(142, 68, 173, 0.2);
      color: #7d3c98;
    }
    
    .user-role.student {
      background: rgba(46, 204, 113, 0.2);
      color: #27ae60;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .demo-buttons {
        grid-template-columns: 1fr;
      }
      
      .stats-dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .header-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
    
    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Success Message */
    .success-message {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
      padding: 15px 20px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="logo">
        <h1><i class="fas fa-graduation-cap"></i> النظام الشامل للوثائق والإشعارات</h1>
      </div>
      <div class="header-controls">
        <select class="user-switcher" id="user-switcher" onchange="switchUser()">
          <option value="teacher1">أحمد المعلم (معلم)</option>
          <option value="parent1">والد علي (ولي أمر)</option>
          <option value="student1">علي الطالب (طالب)</option>
        </select>
        <button class="notifications-btn" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-count">0</span>
        </button>
        <div class="user-info">
          <span class="user-role" id="current-user-role">معلم</span>
          <span id="current-user-name">أحمد المعلم</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- Stats Dashboard -->
      <section class="stats-dashboard">
        <div class="stat-card documents">
          <div class="stat-icon">
            <i class="fas fa-folder-open"></i>
          </div>
          <div class="stat-number" id="documents-count">0</div>
          <div class="stat-label">إجمالي الوثائق</div>
        </div>
        
        <div class="stat-card notifications">
          <div class="stat-icon">
            <i class="fas fa-bell"></i>
          </div>
          <div class="stat-number" id="notifications-total">0</div>
          <div class="stat-label">إجمالي الإشعارات</div>
        </div>
        
        <div class="stat-card users">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-number" id="users-count">7</div>
          <div class="stat-label">المستخدمون</div>
        </div>
        
        <div class="stat-card files">
          <div class="stat-icon">
            <i class="fas fa-file"></i>
          </div>
          <div class="stat-number" id="files-count">0</div>
          <div class="stat-label">الملفات المرفقة</div>
        </div>
      </section>

      <!-- Demo Controls -->
      <section class="demo-controls">
        <h3><i class="fas fa-play-circle"></i> تجربة النظام</h3>
        <div class="demo-buttons">
          <button class="demo-btn homework" onclick="createSampleHomework()">
            <i class="fas fa-tasks"></i>
            إضافة واجب منزلي
          </button>
          <button class="demo-btn lesson" onclick="createSampleLesson()">
            <i class="fas fa-chalkboard-teacher"></i>
            إضافة درس جديد
          </button>
          <button class="demo-btn material" onclick="createSampleMaterial()">
            <i class="fas fa-book"></i>
            إضافة مادة تعليمية
          </button>
          <button class="demo-btn notification" onclick="sendTestNotification()">
            <i class="fas fa-bell"></i>
            إرسال إشعار تجريبي
          </button>
        </div>
      </section>

      <!-- Activity Log -->
      <section class="activity-log">
        <div class="activity-log-header">
          <i class="fas fa-history"></i>
          <h3>سجل الأنشطة</h3>
        </div>
        <div class="activity-log-content" id="activity-log">
          <div class="activity-item">
            <div class="activity-icon notification">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="activity-details">
              <div class="activity-title">مرحباً بك في النظام الشامل</div>
              <div class="activity-description">جرب إضافة واجبات ودروس ومواد تعليمية لرؤية كيفية عمل نظام الإشعارات</div>
              <div class="activity-time">الآن</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Scripts -->
  <script src="js/document-management.js"></script>
  <script src="js/notification-system.js"></script>
  
  <script>
    // Current user
    let currentUser = {
      id: 'teacher1',
      name: 'أحمد المعلم',
      role: 'teacher'
    };

    let activityLog = [];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      updateStats();
      setupNotificationSubscription();
    });

    function initializeApp() {
      // Set current user
      updateCurrentUserDisplay();
      
      // Update notification count
      updateNotificationCount();
      
      // Add welcome activity
      addActivity('system', 'تم تحميل النظام بنجاح', 'النظام جاهز للاستخدام', 'notification');
    }

    function updateCurrentUserDisplay() {
      document.getElementById('current-user-name').textContent = currentUser.name;
      document.getElementById('current-user-role').textContent = 
        currentUser.role === 'teacher' ? 'معلم' : 
        currentUser.role === 'parent' ? 'ولي أمر' : 'طالب';
      document.getElementById('current-user-role').className = `user-role ${currentUser.role}`;
    }

    function switchUser() {
      const userId = document.getElementById('user-switcher').value;
      const user = globalDocumentManager.users.find(u => u.id === userId);
      
      if (user) {
        currentUser = user;
        updateCurrentUserDisplay();
        updateNotificationCount();
        updateStats();
        
        addActivity(user.id, `تم تبديل المستخدم إلى ${user.name}`, `الدور: ${user.role}`, 'notification');
      }
    }

    function setupNotificationSubscription() {
      // Subscribe to notifications for current user
      notificationSystem.subscribe(currentUser.id, (event) => {
        if (event.action === 'new') {
          updateNotificationCount();
          addActivity(event.data.senderId, event.data.title, event.data.message, event.data.type);
        }
      });
    }

    function updateStats() {
      // Documents count
      const userDocuments = globalDocumentManager.getDocumentsByUser(currentUser.id, currentUser.role);
      document.getElementById('documents-count').textContent = userDocuments.length;
      
      // Notifications count
      const userNotifications = notificationSystem.getNotificationsByUser(currentUser.id);
      document.getElementById('notifications-total').textContent = userNotifications.length;
      
      // Files count
      const filesCount = userDocuments.reduce((total, doc) => total + (doc.files ? doc.files.length : 0), 0);
      document.getElementById('files-count').textContent = filesCount;
    }

    function updateNotificationCount() {
      const count = notificationSystem.getUnreadCount(currentUser.id);
      const badge = document.getElementById('notification-count');
      
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    // Demo functions
    function createSampleHomework() {
      if (currentUser.role !== 'teacher') {
        alert('فقط المعلمون يمكنهم إضافة الواجبات');
        return;
      }

      const homeworkData = {
        title: `واجب ${getRandomSubject()} - ${Date.now()}`,
        type: 'homework',
        subject: getRandomSubject(),
        grade: 'الصف التاسع',
        description: 'واجب منزلي تجريبي لاختبار النظام',
        classrooms: ['9أ', '9ب'],
        priority: getRandomPriority(),
        teacherId: currentUser.id,
        teacherName: currentUser.name,
        dueDate: getRandomFutureDate(),
        tags: ['تجريبي', 'واجب']
      };

      const sampleFiles = [
        {
          id: 'file_' + Date.now(),
          name: 'واجب_تجريبي.pdf',
          type: 'application/pdf',
          size: 1024000,
          url: '#',
          uploadDate: new Date().toISOString()
        }
      ];

      const newHomework = globalDocumentManager.addDocument(homeworkData, sampleFiles);
      
      if (newHomework) {
        showSuccessMessage('تم إنشاء الواجب المنزلي بنجاح!');
        updateStats();
        addActivity(currentUser.id, `تم إنشاء واجب جديد`, newHomework.title, 'homework');
        
        // Send notifications
        const recipients = getRecipients(newHomework.classrooms);
        notificationSystem.createHomeworkNotification(newHomework, recipients);
      }
    }

    function createSampleLesson() {
      if (currentUser.role !== 'teacher') {
        alert('فقط المعلمون يمكنهم إضافة الدروس');
        return;
      }

      const lessonData = {
        title: `درس ${getRandomSubject()} - ${Date.now()}`,
        type: 'lesson',
        subject: getRandomSubject(),
        grade: 'الصف التاسع',
        description: 'درس تجريبي لاختبار النظام',
        classrooms: ['9أ', '9ج'],
        priority: getRandomPriority(),
        teacherId: currentUser.id,
        teacherName: currentUser.name,
        tags: ['تجريبي', 'درس']
      };

      const sampleFiles = [
        {
          id: 'file_' + Date.now(),
          name: 'عرض_الدرس.pptx',
          type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
          size: 2048000,
          url: '#',
          uploadDate: new Date().toISOString()
        }
      ];

      const newLesson = globalDocumentManager.addDocument(lessonData, sampleFiles);
      
      if (newLesson) {
        showSuccessMessage('تم إنشاء الدرس بنجاح!');
        updateStats();
        addActivity(currentUser.id, `تم إنشاء درس جديد`, newLesson.title, 'lesson');
        
        // Send notifications
        const recipients = getRecipients(newLesson.classrooms);
        notificationSystem.createLessonNotification(newLesson, recipients);
      }
    }

    function createSampleMaterial() {
      if (currentUser.role !== 'teacher') {
        alert('فقط المعلمون يمكنهم إضافة المواد التعليمية');
        return;
      }

      const materialData = {
        title: `مادة تعليمية ${getRandomSubject()} - ${Date.now()}`,
        type: 'material',
        subject: getRandomSubject(),
        grade: 'الصف التاسع',
        description: 'مادة تعليمية تجريبية لاختبار النظام',
        classrooms: ['9أ', '9ب', '9ج'],
        priority: getRandomPriority(),
        teacherId: currentUser.id,
        teacherName: currentUser.name,
        tags: ['تجريبي', 'مادة تعليمية']
      };

      const sampleFiles = [
        {
          id: 'file_' + Date.now(),
          name: 'مادة_تعليمية.pdf',
          type: 'application/pdf',
          size: 1536000,
          url: '#',
          uploadDate: new Date().toISOString()
        }
      ];

      const newMaterial = globalDocumentManager.addDocument(materialData, sampleFiles);
      
      if (newMaterial) {
        showSuccessMessage('تم إنشاء المادة التعليمية بنجاح!');
        updateStats();
        addActivity(currentUser.id, `تم إنشاء مادة تعليمية جديدة`, newMaterial.title, 'material');
        
        // Send notifications
        const recipients = getRecipients(newMaterial.classrooms);
        notificationSystem.createMaterialNotification(newMaterial, recipients);
      }
    }

    function sendTestNotification() {
      const testNotification = notificationSystem.createNotification({
        title: 'إشعار تجريبي',
        message: 'هذا إشعار تجريبي لاختبار النظام',
        type: 'info',
        senderId: currentUser.id,
        senderName: currentUser.name,
        recipientIds: [currentUser.id],
        priority: 'normal'
      });

      showSuccessMessage('تم إرسال الإشعار التجريبي!');
      addActivity(currentUser.id, 'تم إرسال إشعار تجريبي', 'إشعار لاختبار النظام', 'notification');
    }

    function toggleNotifications() {
      // In a real application, this would open a notifications panel
      const notifications = notificationSystem.getNotificationsByUser(currentUser.id);
      const unreadCount = notificationSystem.getUnreadCount(currentUser.id);
      
      alert(`لديك ${notifications.length} إشعار، منها ${unreadCount} غير مقروء`);
      
      // Mark all as read for demo
      notificationSystem.markAllAsRead(currentUser.id);
      updateNotificationCount();
    }

    // Helper functions
    function getRandomSubject() {
      const subjects = ['الرياضيات', 'العلوم', 'اللغة العربية', 'التاريخ', 'الجغرافيا'];
      return subjects[Math.floor(Math.random() * subjects.length)];
    }

    function getRandomPriority() {
      const priorities = ['low', 'normal', 'high', 'urgent'];
      return priorities[Math.floor(Math.random() * priorities.length)];
    }

    function getRandomFutureDate() {
      const today = new Date();
      const futureDate = new Date(today.getTime() + Math.random() * 14 * 24 * 60 * 60 * 1000);
      return futureDate.toISOString().split('T')[0];
    }

    function getRecipients(classrooms) {
      const recipients = [];
      
      // Get students in these classrooms
      const students = globalDocumentManager.users.filter(user => 
        user.role === 'student' && classrooms.includes(user.classroom)
      );
      
      recipients.push(...students.map(s => s.id));
      
      // Get parents of these students
      const parentIds = students.map(s => s.parentId).filter(Boolean);
      recipients.push(...parentIds);
      
      return recipients;
    }

    function addActivity(userId, title, description, type) {
      const user = globalDocumentManager.users.find(u => u.id === userId) || { name: 'النظام' };
      
      const activity = {
        id: Date.now(),
        userId: userId,
        userName: user.name,
        title: title,
        description: description,
        type: type,
        timestamp: new Date().toISOString()
      };

      activityLog.unshift(activity);
      
      // Keep only last 20 activities
      if (activityLog.length > 20) {
        activityLog = activityLog.slice(0, 20);
      }
      
      renderActivityLog();
    }

    function renderActivityLog() {
      const container = document.getElementById('activity-log');
      
      container.innerHTML = activityLog.map(activity => `
        <div class="activity-item">
          <div class="activity-icon ${activity.type}">
            <i class="fas ${getActivityIcon(activity.type)}"></i>
          </div>
          <div class="activity-details">
            <div class="activity-title">${activity.title}</div>
            <div class="activity-description">${activity.description}</div>
            <div class="activity-time">${formatTime(activity.timestamp)} - ${activity.userName}</div>
          </div>
        </div>
      `).join('');
    }

    function getActivityIcon(type) {
      const icons = {
        homework: 'fa-tasks',
        lesson: 'fa-chalkboard-teacher',
        material: 'fa-book',
        notification: 'fa-bell',
        system: 'fa-cog'
      };
      return icons[type] || 'fa-info-circle';
    }

    function formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) return 'الآن';
      if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
      
      return date.toLocaleTimeString('ar-SA', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function showSuccessMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'success-message';
      messageDiv.innerHTML = `
        <i class="fas fa-check-circle"></i>
        ${message}
      `;

      const container = document.querySelector('.container');
      container.insertBefore(messageDiv, container.firstChild);

      setTimeout(() => {
        messageDiv.remove();
      }, 3000);
    }

    // Auto-update stats every 10 seconds
    setInterval(() => {
      updateStats();
      updateNotificationCount();
    }, 10000);

    // Initial render
    renderActivityLog();
  </script>
</body>
</html>